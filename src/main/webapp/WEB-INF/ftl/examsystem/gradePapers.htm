<#include "header.htm" parse="true" encoding="UTF-8" >
<style type="text/css">
body {background-color:#eee;}
.ui-widget {font-family:"微软雅黑";}
.fixed{position:fixed; top:0; width:1000px;}
.content {padding:0px;}

.paper_tpct {float:none;background-color:#f5f5f5;padding-top:0;padding-left:10px;margin-bottom:-5px;box-shadow:0 0 5px #aaaaaa;}
.paper_tpcm {width:1000px;box-shadow:0 5px 5px #aaaaaa;}
.paper_tpcmlx2 .examinfo-container {float:left;text-indent:0px;margin-right:40px;}
.paper_tpcmlx2 img {width:16px;height:16px;float:left;margin-right:10px;}
.paper_tpcmlx2 .examinfo {float:left;font-size:16px;}
.examinfo em {font-style:normal;color:#cccccc;}
.paper_tpcmr label button {margin-right:10px;float:left;}
.paper_tpcmr label button.gradepaper-submit {width:86px;height:32px;background-color:#dc0000;color:#FFFFFF;font-size:15px;font-weight:bold;border-radius:3px;}
.paper_tpcmr label button.chooshine-cancel {height:32px;line-height:27px;font-size:15px;background:none;}
.paper_tpct3 {background:none;border:none;}
.paper_tpctlmxp1 {background:none;color:#000000;border-bottom:3px solid #0088ff;}

.text_sju {min-height:0px;padding-bottom:0px;}
.paperx_tl {border-bottom:1px solid #aaa;}
.article_area {margin-left:10px;}

.paperx_comxp .paperx_btda {min-height:32px;padding:10px 0;}
.largermargin {margin-top:60px;}
.paperx_tr1_fs .onequesscore, .gradepaper-gradecontainer > .tkScore {font-size:14px;font-family:Simsun;}
.paperx_tr1_fs em.color-gray {color:#aaa;}
 
/*填空题及解答题本题答案*/
.gradepaper-answers {height:32px;line-height:32px;padding-left:20px;float:left;font-size:14px;}
.gradepaper-title {height:32px;line-height:30px;font-size:14px;font-weight:bold;margin-left:30px;}
.paperxt_tjxb2 input.tkScore{width:35px;height:20px; float:left;margin-left:10px; margin-right:10px; text-align:center;}
.paperxt_tjxb2 .cleanBoth .tkScore {margin-top:2px;}
.gradepaper-gradecontainer {float:left;margin-top:10px;margin-left:25px;}
.gradepaper-gradecontainer .struct-grade-correct, .gradepaper-gradecontainer .struct-grade-false {cursor:pointer;}
.gradepaper-gradecontainer .struct-grade-score {width:36px;height:14px;font-size:14px;text-align:center;color:#333;border:none;border-bottom:1px solid #aaa;float:left;margin:10px 10px auto auto;}
.gradepaper-gradecontainer > span {display:inline-block;margin-top:11px;}
.gradepaper-referanswer {display:none;padding-top:10px;border-top:1px dashed #DDDDDD;}
.gradepaper-commentcontainer {padding:10px 0;border-top:1px dashed #ccc;}
.gradepaper-commentwrap {float:left;}
.gradepaper-commentcontainer .gradepaper-title {float:left;}
.test_box5 {float:left;margin-left:14px;}
.gradepaper-referanswer .test_box5 {margin-left:19px;}

.result_answerCard {display: inline-block; width:22px; hneight:22px; line-height:22px; text-align: center;}
.typedt {font-size:14px; color:#999; margin-bottom:15px;}
.answercard_container { border:1px #d7d7d7 solid; padding-top:20px; padding-left:40px;}

/*底部操作*/
#BootOperates {margin-top:20px;}
#BootOperates .netexamview-bootoperate {float:right;}
#EnterNextType {display:inline-block; width:130px; height:32px; line-height:32px; padding-left:30px; font-size:32px; font-family:微软雅黑; color:#2C92F7; background:url("<@spring.url '/images/examsystem/enter_nexttype.png'/>") no-repeat;}
#EnterNextType:HOVER {color:#FF0000;}

/*主观题对错*/
.gradepaper-gradecontainer .hideimgs {display:none;position:relative;border:1px solid #00afed;background-color:#fff;}
.gradepaper-gradecontainer .showdiv {position:relative;border:1px solid #fff;margin-right:36px;}
.hoverwrap:hover .hideimgs {display:block;}
.hoverwrap:hover .showdiv {display:none;}
.cleanBoth {clear:none;}
.network-stuanswer .cleanBoth {margin-left:-50px;}
.questype5 .paperxt_tjxb2 {padding:0 10px;}

.paperx_tl:hover .quesoperates {display:block;}
.quesoperates {display:none;float:right;margin-right:20px;margin-top:-30px;}
.nextques {display:inline-block;padding-left:18px;background:url("<@spring.url '/images/examsystem/arrow_next.png'/>") no-repeat;color:#888;}
.nextques:hover {color:#ff9900;}
/*录音样式*/
.commentrec {display:inline-block;width:16px;height:24px;cursor:pointer;background:url("<@spring.url '/images/uploadimgs.png' />") no-repeat scroll -165px -3px transparent;}
.recorderwrap {margin-top:-5px;margin-left:78px;}
</style>
<!--[if IE 6]>
<style type="text/css">
html{overflow:hidden;}
body{height:100%;overflow:auto;}
.fixed{position:absolute;top:expression(eval(document.body.scrollTop + 25));}
</style>
<![endif]-->
<div class="content">
<div class="paper_tpct">
	<label>${examInfoMap["exam_name"]!}</label>
</div>
<div class="paper_top">
	<div class="paper_tpcm">
		<div class="paper_tpcml">
			<div class="paper_tpcmlx2">
				<div class="examinfo-container">
					<img alt="题目" src="<@spring.url '/images/examsystem/list_nested_28.png' />">
					<div class="examinfo">
						大题 <span id="bTopic" style="font-size:15px;color:#ff9966;font-weight:700;margin-right:1px;">${examInfoMap["b_topic_num"]!}</span><em> | </em>
						小题 <span id="mTopic" style="font-weight:700;color:#ff9966;">${examInfoMap["m_topic_num"]!}</span>
					</div>
				</div>
				<div class="examinfo-container">
					<img alt="主观题" src="<@spring.url '/images/examsystem/target.png' />">
					<div class="examinfo">
						主观题<span id="struct-subjectivenum" style="font-weight:700;color:#ff9966;"> <#if markInfo["subjective_num"]??>${markInfo["subjective_num"]}<#else>0</#if> </span>个<em> | </em>
						已批改<span id="struct-markednum" style="font-weight:bold;color:#ff9966;"> <#if markInfo["marked_num"]??>${markInfo["marked_num"]}<#else>0</#if> </span>个
					</div>
				</div>
				<div class="examinfo-container">
					<img src="<@spring.url '/images/examsystem/user_24_blue.png'/>">
					<div class="examinfo">
						<span style="font-weight:700;color:#ff9966;">${markInfo.student_name}</span>
					</div>
				</div>
			</div>
		</div>
		<div class="paper_tpcmr">
			<label><button id='View' class="gradepaper-submit" style="background-color:#00afed;">${view}</button></label>
			<#if markInfo["mark_flag"]!=2>
			<label><button id="struct-grade-save" class="chooshine-btn" style="width:86px;height:32px;line-height:27px;">保存</button></label>
			</#if>
			<label><button id="struct-grade-submit" class="gradepaper-submit">提交结果</button></label>
			<label><button id="struct-grade-quit" class="chooshine-cancel">退出</button></label>
			<div class="nofl"></div>
		</div>
	</div>
</div>
<#-- 下面的div用于消除滚动时闪屏问题 -->
<div></div>
<!-- 列出试卷的所有大题 -->
<div class="paper_tpct3">
	<#if qtList??>
		<#list qtList as list>
			<div class="paper_tpctlm" realityId=${list.TYPE!} id=${list.TYPE_ID?c!} >
				${list.TYPE_NAME!}
				<input type="hidden" id=${"score"+list.TYPE_ID?c} value=${list.DEFAULT_SCORE?c!}>
				<#if bctList??>
					<#list bctList as bct>
						<#if bct_index==list_index>
							<input type="hidden" id=${"bct"+list.TYPE_ID?c} value=${bct+"、"!} >
						</#if>
					</#list>
				</#if>
				<input type="hidden" id=${"detail"+list.TYPE_ID?c} value=${list.TYPE_DETAIL!}>
			</div>
		</#list>
	</#if>
	<div class="nofl"></div>
</div>

<div class="text_sju">
	<div class="paper_tpnav">
		<div class="paper_tpnavc" id="paper_tpnavc">
			<div class="paper_tpnavc1">
				<span id="bctNum"></span>
				<label id="quesTypeDetail"></label>
				<span id="titleAfter" style="padding-left:12px;font-size:12px;color:#fff;">
					(共<span id="nowTopic" style=" padding-left:3px; padding-right:3px; color:#fff;">0</span>
					题 ，共有<span id="nowScore" style=" padding-left:3px; padding-right:3px; color:#fff;">0</span>分) 
				</span>
			</div>
		</div>
	</div>

	<#if qiMap?? && qtList??>
		<#list qtList as list>
			<#if list.type_id??>
			    <#assign items=qiMap[list.type_id?c] >
			    <#if items??>
				<div class="paperx_com" id=${"ques"+list.type_id?c}>
					<ul id=${"ul"+list.type_id?c}>
					<#list items?keys as key>
						<#assign qi = items[key]>
						<#if key?starts_with("normal")>
						<li id="ques${qi.ques_id?c}" questype=${qi.ques_type}>
							<div class="paperx_tl">
								<dl>
									<dt>
										<div class="allNum" mTopic=${qi.M_TOPIC}>${qi.M_TOPIC}</div>
										<div type="title" class="paperx_tlxr" quesid=${qi.QUES_ID?c}>
											<div type='title' class='ttxt test_box equlabel' >
												${qi.QUES_CONTENT}
											</div>
										</div>
										<div class="paperx_tr1_fs">
											<div class="stuscore-container"><input disabled="true" class="struct-stuscore" type="text" value="<#if qi.stu_score!=-1>${qi.stu_score}<#else>0</#if>"></div>
											<div><em class="color-gray">/ </em><em class="onequesscore">${qi.SCORE}</em><span> 分</span></div>
										</div>
										<div class="nofl"></div>
									</dt>
									<#if qi.QUES_TYPE=='1' || qi.QUES_TYPE=='2'>
										<#list qi.OPT_CONTENT as optContent>
											<#list qi.OPT_ID as optId>
											    <#if optContent_index==optId_index>
													<dd class="test_box2_bgc">
														<div class="pap_tlt">${qi.OPT_NO[optId_index]+"."}</div>
														<div type="option" class="pap_tct questionItme" optid=${optId?c}>
															<div class='ttxt test_box2 equlabel'>${optContent}</div>
														</div>
														<div class="nofl"></div>
													</dd>
												</#if>
											</#list>
										</#list>
									</#if>
								</dl>
								<!-- 本题答案 -->
								<div class="paperx_btda">
									<#-- 普通小题 -->
									<#if qi.QUES_TYPE!='4' && qi.QUES_TYPE!='5'>
										<#if qi.STUDENT_ANSWER=="@#@#">
											<img class="network-duicuoimg" src="<@spring.url '/images/examsystem/gradePaper_right.png'/>"/>
											<div class="gradepaper-answers">
												<span>回答正确！正确答案是：</span>
												<span>${qi.QUES_REFER ?replace("@@", "、")}</span>
											</div>
										<#else>
											<img class="network-duicuoimg" src="<@spring.url '/images/examsystem/gradePaper_fault.png'/>" />
											<div class="gradepaper-answers">
												<#if qi.STUDENT_ANSWER??>
												<span>考生答案是：</span>
												<span>${qi.STUDENT_ANSWER ?replace("@@", "、")}，</span>
												<#else>
												<span>考生没有回答该题，</span>
												</#if>
												<!-- 正确答案部分 -->
												<span>正确答案是：</span>
												<span>${qi.QUES_REFER ?replace("@@", "、")}</span>
											</div>
										</#if>
									<#elseif qi.QUES_TYPE=='4'>
										<div class="network-stuanswer">
											<div class="gradepaper-title">考生答案：</div>
											<div class="paperx_tjx paperx_line_tjx">
												<#assign index3=0 > <#--填空题的选项号索引-->
												<#if qi.STU_OSCORE??>
													<#assign stuOScoreArr=qi.STU_OSCORE ?split(",")>
												</#if>
												<#list qi.OPT_NO as l>
												<div class="paperxt_tjxb2">
													<div class="gradepaper-gradecontainer struct-gradecontainer">
													<#if stuOScoreArr??>
														<#if stuOScoreArr[l_index]==qi.O_SCORE[l_index]>
															<div class="showdiv"><img alt="对" class="struct-grade-correct struct-showimg" src="<@spring.url '/images/examsystem/gradePaper_right.png'/>" /></div>
																<div class="hideimgs">
																	<img alt="对" class="struct-grade-correct firsthideimg" src="<@spring.url '/images/examsystem/gradePaper_right.png'/>" />
																	<img alt="错" class="struct-grade-false secondhideimg" src="<@spring.url '/images/examsystem/gradePaper_fault.png'/>" />
																</div>
															<#elseif stuOScoreArr[l_index]!="">
																<div class="showdiv"><img alt="错" class="struct-grade-false struct-showimg" src="<@spring.url '/images/examsystem/gradePaper_fault.png'/>" /></div>
																<div class="hideimgs">
																	<img alt="错" class="struct-grade-false firsthideimg" src="<@spring.url '/images/examsystem/gradePaper_fault.png'/>" />
																	<img alt="对" class="struct-grade-correct secondhideimg" src="<@spring.url '/images/examsystem/gradePaper_right.png'/>" />
																</div>
															<#else>
																<div class="showdiv"><img alt="对" class="struct-grade-false struct-showimg" src="<@spring.url '/images/examsystem/gradePaper_right_gray.png'/>" /></div>
																<div class="hideimgs">
																	<img alt="对" class="struct-grade-correct firsthideimg" src="<@spring.url '/images/examsystem/gradePaper_right.png'/>" />
																	<img alt="错" class="struct-grade-false secondhideimg" src="<@spring.url '/images/examsystem/gradePaper_fault.png'/>" />
																</div>
															</#if>
														<#else>
															<div class="showdiv"><img alt="对" class="struct-grade-false struct-showimg" src="<@spring.url '/images/examsystem/gradePaper_right_gray.png'/>" /></div>
															<div class="hideimgs">
																<img alt="对" class="struct-grade-correct firsthideimg" src="<@spring.url '/images/examsystem/gradePaper_right.png'/>" />
																<img alt="错" class="struct-grade-false secondhideimg" src="<@spring.url '/images/examsystem/gradePaper_fault.png'/>" />
															</div>
														</#if>
													</div>
													<div class="cleanBoth">
														<span class="tkNum">${l}</span>
														<#assign lineContent="">
														<#if qi.STUDENT_ANSWER??>
															<#list qi.STUDENT_ANSWER?split("@@") as sa>
																<#if sa?starts_with(l+"##")>
																	<#assign lineContent=sa?substring(sa?index_of("##")+2)>
																</#if>
															</#list>
														</#if>
														<div class='test_box4 test_bg equlabel' optId="${qi.OPT_ID[l_index]?c}">${lineContent}</div>
													</div>
													<div class="gradepaper-gradecontainer struct-gradecontainer">
														<#if stuOScoreArr??>
															<input class="struct-grade-score" type="text" value="${stuOScoreArr[l_index]}"/>
															<span class="color-gray">/</span>
															<span class='tkScore'>${qi.O_SCORE[index3]}</span>
															<span class="color-blue">分</span>
														<#else>
															<input class="struct-grade-score" type="text"/>
															<span class="color-gray">/</span>
															<span class='tkScore'>${qi.O_SCORE[index3]}</span><span style="color:#00afed;">分</span>
														</#if>
													</div>
													<div class="nofl"></div>
												</div>
												<#assign index3=index3+1>
												</#list>
											</div>
											<div class="nofl"></div>
											<div class="network-openrefer"><span class="struct-opencmd">查看答案▼</span></div>
										</div>
										<div class="gradepaper-referanswer">
											<div class="gradepaper-title">参考答案：</div>
											<div class="paperx_tjx paperx_line_tjx">
												<#assign index3=-1 > <#--填空题的选项号索引-->
												<#list qi.OPT_REFER as l>
												<#assign index3=index3+1>
												<div class="paperxt_tjxb2">
													<div class="cleanBoth">
														<span class="tkNum">${qi.OPT_NO[index3]}</span>
														<div class='test_box4 equlabel'>${l}</div>
													</div>
												</div>
												</#list>
											</div>
											<div class="nofl"></div>
										</div>
										<div class="gradepaper-commentcontainer">
											<div class="gradepaper-title">评语：</div>
											<div class='gradepaper-commentwrap'>
												<#if qi.teacher_comment??&&qi.teacher_comment!="">
												<div class="gradepaper-comment struct-comment equ test_box4 test_bg" contenteditable="true">${qi.teacher_comment}</div>
												<#else>
												<div class="gradepaper-comment struct-comment equ test_box4 test_bg" contenteditable="true" style="color:#ddd;">点击输入评语</div>
												</#if>
												
												<div class='linkClass2 linkClass4_postion'>
													<!-- <span><img title="添加公式" class="addequation" src="<@spring.url '/images/examsystem/sigma_grey.png'/>"></span>
													<span><img title="上传图片" class="addequation_local" src="<@spring.url '/images/examsystem/image_grey.png'/>"></span> -->
													<span><img title='创建公式' class='struct-kf' src='<@spring.url '/images/examsystem/kf.png'/>'></span>
													<span><img title='使用编辑器' class='struct-ue' src='<@spring.url '/images/examsystem/ue.png'/>'></span>
													<span><img title='公式历史' class='struct-hist' src='<@spring.url '/images/clock_gray.png'/>'></span>
													<span title="录音" class="commentrec struct-commentrec">&nbsp;</span>
												</div>
											</div>
											<div class="nofl"></div>
										</div>
										<div class="recorderwrap" recpath="${qi.comment_rec}"></div>
										<div class="nofl"></div>
									<#elseif qi.QUES_TYPE=='5'>
										<div class="network-stuanswer">
											<div class="gradepaper-title">考生答案：</div>
											<div class='questype5'>
												<div class="paperxt_tjxb2">
													<div class="gradepaper-gradecontainer struct-gradecontainer">
														<#if qi.STU_SCORE=-1>
															<div class="showdiv"><img alt="对" class="struct-grade-false struct-showimg" src="<@spring.url '/images/examsystem/gradePaper_right_gray.png'/>" /></div>
															<div class="hideimgs">
																<img alt="对" class="struct-grade-correct firsthideimg" src="<@spring.url '/images/examsystem/gradePaper_right.png'/>" />
																<img alt="错" class="struct-grade-false secondhideimg" src="<@spring.url '/images/examsystem/gradePaper_fault.png'/>" />
															</div>
														<#elseif qi.STU_SCORE=qi.SCORE>
															<div class="showdiv"><img alt="对" class="struct-grade-correct struct-showimg" src="<@spring.url '/images/examsystem/gradePaper_right.png'/>" /></div>
															<div class="hideimgs">
																<img alt="对" class="struct-grade-correct firsthideimg" src="<@spring.url '/images/examsystem/gradePaper_right.png'/>" />
																<img alt="错" class="struct-grade-false secondhideimg" src="<@spring.url '/images/examsystem/gradePaper_fault.png'/>" />
															</div>
														<#else>
															<div class="showdiv"><img alt="错" class="struct-grade-false struct-showimg" src="<@spring.url '/images/examsystem/gradePaper_fault.png'/>" /></div>
															<div class="hideimgs">
																<img alt="错" class="struct-grade-false firsthideimg" src="<@spring.url '/images/examsystem/gradePaper_fault.png'/>" />
																<img alt="对" class="struct-grade-correct secondhideimg" src="<@spring.url '/images/examsystem/gradePaper_right.png'/>" />
															</div>
														</#if>
													</div>
													<div class="cleanBoth">
														<div class='test_box5 test_bg equlabel'>${qi.STUDENT_ANSWER}</div>
														<div class="gradepaper-gradecontainer">
															<#if qi.STU_SCORE=-1>
																<input class="struct-grade-score" type="text"/>
																<span class="color-blue">分</span>
															<#elseif qi.STU_SCORE=qi.SCORE>
																<input class="struct-grade-score" type="text" value="${qi.STU_SCORE}"/>
																<span class="color-blue">分</span>
															<#else>
																<input class="struct-grade-score" type="text" value="${qi.STU_SCORE}"/>
																<span class="color-blue">分</span>
															</#if>
														</div>
													</div>
												</div>
											</div>
											<div class="nofl"></div>
											<div class="network-openrefer"><span class="struct-opencmd">查看答案▼</span></div>
										</div>
										<div class="gradepaper-referanswer">
											<div class="gradepaper-title">参考答案：</div>
											<div>
												<div class="paperxt_tjxb2">
													<div class="cleanBoth">
														<div class='test_box5 gradepaper-refer-type5 equlabel'>${qi.QUES_REFER}</div>
													</div>
												</div>
											</div>
											<div class="nofl"></div>
										</div>
										<div class="gradepaper-commentcontainer">
											<div class="gradepaper-title">评语：</div>
											<div class='gradepaper-commentwrap'>
												<#if qi.teacher_comment??&&qi.teacher_comment!="">
												<div class="struct-comment gradepaper-comment equ test_box4 test_bg" contenteditable="true">${qi.teacher_comment}</div>
												<#else>
												<div class="struct-comment gradepaper-comment equ test_box4 test_bg" contenteditable="true" style="color:#ddd;">点击输入评语</div>
												</#if>
												<div class='linkClass2 linkClass4_postion'>
													<!-- <span><img title="添加公式" class="addequation" src="<@spring.url '/images/examsystem/sigma_grey.png'/>"></span>
													<span><img title="上传图片" class="addequation_local" src="<@spring.url '/images/examsystem/image_grey.png'/>"></span> -->
													<span><img title='创建公式' class='struct-kf' src='<@spring.url '/images/examsystem/kf.png'/>'></span>
													<span><img title='使用编辑器' class='struct-ue' src='<@spring.url '/images/examsystem/ue.png'/>'></span>
													<span><img title='公式历史' class='struct-hist' src='<@spring.url '/images/clock_gray.png'/>'></span>
													<span title="录音" class="commentrec struct-commentrec">&nbsp;</span>
												</div>
											</div>
											<div class="nofl"></div>
										</div>
										<div class="recorderwrap" recpath="${qi.comment_rec}"></div>
										<div class="nofl"></div>
									</#if>
								</div>
								
								<!-- 下一题 -->
								<div class="quesoperates">
									<div class="quesoperate"><a class="nextques struct-nq">下一题</a></div>
								</div>
							</div>
						</li>
						<#else>
						<li>
							<#assign articleUlId="">
							<div class='paperxtc_com'>
								<div class='paperxt_stx'>
								<#list qi as tkList>
									<#list tkList as tkl>
										<#if tkl.ques_type==6>
											<#assign articleUlId=tkl.ques_id?c>
											<#--文章内容部分-->
											<div class="article_area">
												<div class='articletip'>（材料）</div>
												<div remark='article' class="questionItme paperxt_com test_box6 equlabel"  type="artlic" artid=${tkl.QUES_ID?c}>${tkl.QUES_CONTENT}</div>
											</div>
											<div class="nofl"></div>
										</#if>
									</#list>
								</#list>
								</div>
								<div class='paperxt_bot'>
									<ul id=${"ul"+articleUlId+"a"}>
									<#list qi as tkList>
										<#list tkList as tkl>
											<#if tkl.ques_type!=6>
												<li id="ques${tkl.QUES_ID?c}" questype=${tkl.ques_type}>
													<div class="paperx_tl">
														<dl>
															<dt>
																<div class="allNum" mTopic="${tkl.M_TOPIC}">${tkl.M_TOPIC}</div>
																<div type="title" class="paperx_tlxr" quesid=${tkl.QUES_ID?c}>
																	<div  type='title' class='ttxt test_box equlabel'>
																		${tkl.QUES_CONTENT}
																	</div>
																</div>
																<div class="paperx_tr1_fs">
																	<div class="stuscore-container"><input disabled="true" class="struct-stuscore" type="text" value="<#if tkl.stu_score!=-1>${tkl.stu_score}<#else>0</#if>"></div>
																	<div><em class="color-gray">/ </em><em class="onequesscore">${tkl.SCORE}</em><span> 分</span></div>
																</div>
																<div class="nofl"></div>
															</dt>
															<#if tkl.QUES_TYPE=='1' || tkl.QUES_TYPE=='2'> 
																<#list tkl.OPT_CONTENT as optContent>
																	<#list tkl.OPT_ID as optId>
																		<#if optContent_index==optId_index>
																			<dd class='test_box2_bgc'>
																				<div class="pap_tlt">${tkl.OPT_NO[optId_index]}</div>
																				<div type="option" class="pap_tct questionItme" optid=${optId?c}>
																					<div class='ttxt test_box2 equlabel'>${optContent}</div>
																				</div>
																				<div class="nofl"></div>
																			</dd>
																		</#if>
																	</#list> 
																</#list> 
															</#if>
														</dl>
														<div class="paperx_btda">
															<#-- 普通小题 -->
															<#if tkl.QUES_TYPE!='4' && tkl.QUES_TYPE!='5'>
																<#if tkl.STUDENT_ANSWER=="@#@#">
																	<img class="network-duicuoimg" src="<@spring.url '/images/examsystem/gradePaper_right.png'/>"/>
																	<div class="gradepaper-answers">
																		<span>回答正确！正确答案是：</span>
																		<span>${tkl.QUES_REFER ?replace("@@", "、")}</span>
																	</div>
																<#else>
																	<img class="network-duicuoimg" src="<@spring.url '/images/examsystem/gradePaper_fault.png'/>" />
																	<div class="gradepaper-answers">
																		<#if tkl.STUDENT_ANSWER??>
																		<span>考生答案是：</span>
																		<span>${tkl.STUDENT_ANSWER ?replace("@@", "、")}，</span>
																		<#else>
																		<span>考生没有回答该题，</span>
																		</#if>
																		<!-- 正确答案部分 -->
																		<span>正确答案是：</span>
																		<span>${tkl.QUES_REFER ?replace("@@", "、")}</span>
																	</div>
																</#if>
															<#elseif tkl.QUES_TYPE=='4'>
															<div class="network-stuanswer">
																<div class="gradepaper-title">考生答案：</div>
																<div class="paperx_tjx paperx_line_tjx">
																	<#assign index3=0 > <#--填空题的选项号索引-->
																	<#if tkl.STU_OSCORE??>
																		<#assign stuOScoreArr=tkl.STU_OSCORE ?split(",")>
																	</#if>
																	<#list tkl.OPT_NO as l>
																	<div class="paperxt_tjxb2">
																		<div class="gradepaper-gradecontainer struct-gradecontainer">
																		<#if stuOScoreArr??>
																			<#if stuOScoreArr[l_index]==tkl.O_SCORE[l_index]>
																				<div class="showdiv"><img alt="对" class="struct-grade-correct struct-showimg" src="<@spring.url '/images/examsystem/gradePaper_right.png'/>" /></div>
																					<div class="hideimgs">
																						<img alt="对" class="struct-grade-correct firsthideimg" src="<@spring.url '/images/examsystem/gradePaper_right.png'/>" />
																						<img alt="错" class="struct-grade-false secondhideimg" src="<@spring.url '/images/examsystem/gradePaper_fault.png'/>" />
																					</div>
																				<#elseif stuOScoreArr[l_index]!="">
																					<div class="showdiv"><img alt="错" class="struct-grade-false struct-showimg" src="<@spring.url '/images/examsystem/gradePaper_fault.png'/>" /></div>
																					<div class="hideimgs">
																						<img alt="错" class="struct-grade-false firsthideimg" src="<@spring.url '/images/examsystem/gradePaper_fault.png'/>" />
																						<img alt="对" class="struct-grade-correct secondhideimg" src="<@spring.url '/images/examsystem/gradePaper_right.png'/>" />
																					</div>
																				<#else>
																					<div class="showdiv"><img alt="对" class="struct-grade-false struct-showimg" src="<@spring.url '/images/examsystem/gradePaper_right_gray.png'/>" /></div>
																					<div class="hideimgs">
																						<img alt="对" class="struct-grade-correct firsthideimg" src="<@spring.url '/images/examsystem/gradePaper_right.png'/>" />
																						<img alt="错" class="struct-grade-false secondhideimg" src="<@spring.url '/images/examsystem/gradePaper_fault.png'/>" />
																					</div>
																				</#if>
																			<#else>
																				<div class="showdiv"><img alt="对" class="struct-grade-false struct-showimg" src="<@spring.url '/images/examsystem/gradePaper_right_gray.png'/>" /></div>
																				<div class="hideimgs">
																					<img alt="对" class="struct-grade-correct firsthideimg" src="<@spring.url '/images/examsystem/gradePaper_right.png'/>" />
																					<img alt="错" class="struct-grade-false secondhideimg" src="<@spring.url '/images/examsystem/gradePaper_fault.png'/>" />
																				</div>
																			</#if>
																		</div>
																		<div class="cleanBoth">
																			<span class="tkNum">${l}</span>
																			<#assign lineContent="">
																			<#if tkl.STUDENT_ANSWER??>
																				<#list tkl.STUDENT_ANSWER?split("@@") as sa>
																					<#if sa?starts_with(l+"##")>
																						<#assign lineContent=sa?substring(sa?index_of("##")+2)>
																					</#if>
																				</#list>
																			</#if>
																			<div class='test_box4 test_bg equlabel' optId="${tkl.OPT_ID[l_index]?c}">${lineContent}</div>
																		</div>
																		<div class="gradepaper-gradecontainer struct-gradecontainer">
																			<#if stuOScoreArr??>
																				<input class="struct-grade-score" type="text" value="${stuOScoreArr[l_index]}"/>
																				<span class="color-gray">/</span>
																				<span class='tkScore'>${tkl.O_SCORE[index3]}</span>
																				<span class="color-blue">分</span>
																			<#else>
																				<input class="struct-grade-score" type="text"/>
																				<span class="color-gray">/</span>
																				<span class='tkScore'>${tkl.O_SCORE[index3]}</span>
																				<span class="color-blue">分</span>
																			</#if>
																		</div>
																		<div class="nofl"></div>
																	</div>
																	<#assign index3=index3+1>
																	</#list>
																</div>
																<div class="nofl"></div>
																<div class="network-openrefer"><span class="struct-opencmd">查看答案▼</span></div>
															</div>
															
															<div class="gradepaper-referanswer">
																<div class="gradepaper-title">参考答案：</div>
																<div class="paperx_tjx paperx_line_tjx">
																	<#assign index3=-1 > <#--填空题的选项号索引-->
																	<#list tkl.OPT_REFER as l>
																	<#assign index3=index3+1>
																	<div class="paperxt_tjxb2">
																		<div class="cleanBoth">
																			<span class="tkNum">${tkl.OPT_NO[index3]}</span>
																			<div class='test_box4 equlabel'>${l}</div>
																		</div>
																	</div>
																	</#list>
																</div>
																<div class="nofl"></div>
															</div>
															<div class="gradepaper-commentcontainer">
																<div class="gradepaper-title">评语：</div>
																<div class='gradepaper-commentwrap'>
																	<#if tkl.teacher_comment??&&tkl.teacher_comment!="">
																	<div class="gradepaper-comment struct-comment equ test_box4 test_bg" contenteditable="true">${tkl.teacher_comment}</div>
																	<#else>
																	<div class="gradepaper-comment struct-comment equ test_box4 test_bg" contenteditable="true" style="color:#ddd;">点击输入评语</div>
																	</#if>
																	
																	<div class='linkClass2 linkClass4_postion'>
																		<!-- <span><img title="添加公式" class="addequation" src="<@spring.url '/images/examsystem/sigma_grey.png'/>"></span>
																		<span><img title="上传图片" class="addequation_local" src="<@spring.url '/images/examsystem/image_grey.png'/>"></span> -->
																		<span><img title='创建公式' class='struct-kf' src='<@spring.url '/images/examsystem/kf.png'/>'></span>
																		<span><img title='使用编辑器' class='struct-ue' src='<@spring.url '/images/examsystem/ue.png'/>'></span>
																		<span><img title='公式历史' class='struct-hist' src='<@spring.url '/images/clock_gray.png'/>'></span>
																		<span title="录音" class="commentrec struct-commentrec">&nbsp;</span>
																	</div>
																</div>
																<div class="nofl"></div>
															</div>
															<div class="recorderwrap" recpath="${tkl.comment_rec}"></div>
															<div class="nofl"></div>
															<#elseif tkl.QUES_TYPE=='5'>
															<div class="network-stuanswer">
																<div class="gradepaper-title">考生答案：</div>
																<div>
																	<div class="paperxt_tjxb2">
																		<div class="gradepaper-gradecontainer struct-gradecontainer">
																			<#if tkl.STU_SCORE=-1>
																				<div class="showdiv"><img alt="对" class="struct-grade-false struct-showimg" src="<@spring.url '/images/examsystem/gradePaper_right_gray.png'/>" /></div>
																				<div class="hideimgs">
																					<img alt="对" class="struct-grade-correct firsthideimg" src="<@spring.url '/images/examsystem/gradePaper_right.png'/>" />
																					<img alt="错" class="struct-grade-false secondhideimg" src="<@spring.url '/images/examsystem/gradePaper_fault.png'/>" />
																				</div>
																			<#elseif tkl.STU_SCORE=tkl.SCORE>
																				<div class="showdiv"><img alt="对" class="struct-grade-correct struct-showimg" src="<@spring.url '/images/examsystem/gradePaper_right.png'/>" /></div>
																				<div class="hideimgs">
																					<img alt="对" class="struct-grade-correct firsthideimg" src="<@spring.url '/images/examsystem/gradePaper_right.png'/>" />
																					<img alt="错" class="struct-grade-false secondhideimg" src="<@spring.url '/images/examsystem/gradePaper_fault.png'/>" />
																				</div>
																			<#else>
																				<div class="showdiv"><img alt="错" class="struct-grade-false struct-showimg" src="<@spring.url '/images/examsystem/gradePaper_fault.png'/>" /></div>
																				<div class="hideimgs">
																					<img alt="错" class="struct-grade-false firsthideimg" src="<@spring.url '/images/examsystem/gradePaper_fault.png'/>" />
																					<img alt="对" class="struct-grade-correct secondhideimg" src="<@spring.url '/images/examsystem/gradePaper_right.png'/>" />
																				</div>
																			</#if>
																		</div>
																		<div class="cleanBoth">
																			<div class='test_box5 test_bg equlabel'>${tkl.STUDENT_ANSWER}</div>
																			<div class="gradepaper-gradecontainer">
																				<#if tkl.STU_SCORE=-1>
																					<input class="struct-grade-score" type="text"/>
																					<span class="color-blue">分</span>
																				<#elseif tkl.STU_SCORE=tkl.SCORE>
																					<input class="struct-grade-score" type="text" value="${tkl.STU_SCORE}"/>
																					<span class="color-blue">分</span>
																				<#else>
																					<input class="struct-grade-score" type="text" value="${tkl.STU_SCORE}"/>
																					<span class="color-blue">分</span>
																				</#if>
																			</div>
																		</div>
																	</div>
																</div>
																<div class="nofl"></div>
																<div class="network-openrefer"><span class="struct-opencmd">查看答案▼</span></div>
															</div>
															<div class="gradepaper-referanswer">
																<div class="gradepaper-title">参考答案：</div>
																<div>
																	<div class="paperxt_tjxb2">
																		<div class="cleanBoth">
																			<div class='test_box5 gradepaper-refer-type5 equlabel'>${tkl.QUES_REFER}</div>
																		</div>
																	</div>
																</div>
																<div class="nofl"></div>
															</div>
															<div class="gradepaper-commentcontainer">
																<div class="gradepaper-title">评语：</div>
																<div class='gradepaper-commentwrap'>
																	<#if tkl.teacher_comment??&&tkl.teacher_comment!="">
																	<div class="gradepaper-comment struct-comment equ test_box4 test_bg" contenteditable="true">${tkl.teacher_comment}</div>
																	<#else>
																	<div class="gradepaper-comment struct-comment equ test_box4 test_bg" contenteditable="true" style="color:#ddd;">点击输入评语</div>
																	</#if>
																	<div class='linkClass2 linkClass4_postion'>
																		<!-- <span><img title="添加公式" class="addequation" src="<@spring.url '/images/examsystem/sigma_grey.png'/>"></span>
																		<span><img title="上传图片" class="addequation_local" src="<@spring.url '/images/examsystem/image_grey.png'/>"></span> -->
																		<span><img title='创建公式' class='struct-kf' src='<@spring.url '/images/examsystem/kf.png'/>'></span>
																		<span><img title='使用编辑器' class='struct-ue' src='<@spring.url '/images/examsystem/ue.png'/>'></span>
																		<span><img title='公式历史' class='struct-hist' src='<@spring.url '/images/clock_gray.png'/>'></span>
																		<span title="录音" class="commentrec struct-commentrec">&nbsp;</span>
																	</div>
																</div>
																<div class="nofl"></div>
															</div>
															<div class="recorderwrap" recpath="${tkl.comment_rec}"></div>
															<div class="nofl"></div>
															</#if>
														</div>
													
														<!-- 下一题 -->
														<div class="quesoperates">
															<div class="quesoperate"><a class="nextques struct-nq">下一题</a></div>
														</div>
													</div>
													<div class="nofl"></div>
												</li> 
											</#if> 
										</#list>
									</#list>
									</ul>
								</div>
							</div>
						</li>
						</#if>
					</#list>
					</ul>
				</div>
				</#if>
			</#if>
		</#list>
	</#if>
</div>

<div id="BootOperates">
	<div class="netexamview-bootoperate"><a id="EnterNextType">下一大题</a></div>
	<div class="nofl"></div>
</div>

<!-- 答题卡 -->
<#include "network/answerCard.htm" parse="true" encoding="UTF-8">

<form id="SubmitGradeResult" action="<@spring.url '/examsystem/showMarkedResult.html'/>" method="post">
	<input type="hidden" name="examId" value="${examInfoMap['exam_id']?c}" />
	<input type="hidden" name="testRecId" value="${testRecId?c}" />
	<input type="hidden" name="classId" value="${classInfo.class_id?c}" />
	<input type="hidden" name="testId" value="${classInfo.test_id?c}" />
	<input type="hidden" name="subjectId" value="${classInfo.sort_id?c}" />
</form>

<form id="QuitExam" action="<@spring.url '/network/showEnterExamStudents.html'/>" method="post">
	<input type="hidden" name="testId" value="${classInfo.test_id?c}" />
	<input type="hidden" name="subjectId" value="${classInfo.sort_id?c}" />
</form>
</div>
<#include "bottom.htm" parse="true" encoding="UTF-8" >
<#-- 插入公式 -->
<#include "insertFormulaDialog.htm" parse="true" encoding="UTF-8" >
<#include "formulaDialog.htm" parse="true" encoding="UTF-8" >
<#include "formula/formulaHistoryDialog.htm" parse="true" encoding="UTF-8" >
<#include "recorder.htm" parse="true" encoding="UTF-8" >
<script>
$(function(){
	var typeInfo = ${typeInfo};
	var nowId = $(".paper_tpctlm :first").attr('id');		//用于存放当前的题型id
	var oldId = '';		//原来的题型id
	var nowQuesType = '';
	var bQuesType = '';
	var examId = ${examInfoMap["exam_id"]?c};
	var testId = ${classInfo.test_id?c};
	var testRecId = ${testRecId?c};
	var classId = ${classInfo.class_id?c};
	var subjectId = ${classInfo.sort_id?c};
	var quesScoreArr = {};
	var oScoreArr = {};
	var commentArr = {};
	var viewConstant = '查看全部';//设置一个公用变量，用于与view进行比较
	//查看全部题目的url
	var urlConstant = "<@spring.url '/examsystem/gradePapers.html' />"+"?examId="+examId+"&testRecId="+testRecId+"&classId="+classId+"&testId="+testId+"&subjectId="+subjectId;
	
//******************************页面整体显示效果的设置*******************************
	//滚动条滚动时，让div一直显示在页面顶部
	var paperTopNode = $(".paper_top")[0];
	var startPos = $(paperTopNode).offset().top;
	$(window).scroll(function() {
		fixDiv(paperTopNode, startPos, "fixed", "largermargin");
		fixAnswerCard();
	});
	
	
	initChange();
	function initChange(){
		//切换div与按钮的显示
		if(oldId==''){
			$("#"+nowId).addClass("paper_tpctlmxp1");
			$("#ques"+nowId).attr("class","paperx_comxp");
		}else{
			$("#"+oldId).removeClass("paper_tpctlmxp1");
			$("#"+nowId).addClass("paper_tpctlmxp1");
			$("#ques"+oldId).attr("class","paperx_com");
			$("#ques"+nowId).attr("class","paperx_comxp");
		}
		
		//题目描述
		$('#bctNum').text($('#bct'+nowId).val())
		$("#nowTopic").html(typeInfo[nowId].ques_num);	//改变该大题的所有小题数
		$("#nowScore").html(typeInfo[nowId].score);	//改变该大题下的所有小题的总分
		
		//设置页面最下方的“进入下一大题”节点的相关信息
		if($("#"+nowId).next(".paper_tpctlm")[0] == undefined) {	//如果是最后一个大题，则隐藏“进入下一大题”
			$("#EnterNextType").hide();
		} else {
			$("#EnterNextType").show();
		}
	}
	
	//重新计算每个填空题和解答题的“小题分数”
	$(".paperx_tl").each(function() {
		var liNode = $(this).parents("li")[0];
		if($(liNode).attr("questype")=="4" || $(liNode).attr("questype")=="5") hasUnmarkedLine(liNode);
	});	
	
	//切换大题
	$(".paper_tpctlm").each(function(){
		$(this).click(function(){
			oldId=nowId;
			nowId=($(this).attr("id"));
			initChange();
		});
	});
	
//************************************小题的操作********************************
	//判断小题是否评阅过，如果是，返回true，否则返回false
	function isMarked(liNode) {
		if($($(liNode).find(".struct-stuscore")[0]).val() != "") return true;
		return false;
	}
	
	//判断小题是否有未评阅的选项，如果有，就返回true，否则返回false
	function hasUnmarkedLine(liNode) {
		var flag = false;
		//判断当前小题是否有未评阅的选项，如果有，就跳出方法
		$(liNode).find(".struct-grade-score").each(function() {
			if($(this).val() == "") {
				flag = true;
				$($(liNode).find(".struct-stuscore")[0]).val("");//设置小题得分为空
				return false;
			}
		});
		return flag;
	}
	//计算小题得分
	function computeQuesScore(liNode, isMarkedFlag) {
		if(hasUnmarkedLine(liNode)) return;
		
		//如果小题之前是未被评阅过的（即没有小题得分），则需要将已评阅小题数量增加
		if(!isMarkedFlag) {
			if(parseInt($("#struct-markednum").html()) < parseInt($("#struct-subjectivenum").html())) {
				$("#struct-markednum").html(parseInt($("#struct-markednum").html())+1);
				$("#mtopic"+$(liNode).find(".allNum").eq(0).attr("mtopic")).removeClass("answercard-gray").addClass("answercard-blue");
			}
		}
		
		//计算小题得分
		var quesScore = 0;
		var stuScoreNode = $(liNode).find(".struct-stuscore")[0];
		$(liNode).find(".struct-grade-score").each(function() {
			quesScore = quesScore+parseInt($(this).val());
		});
		$(stuScoreNode).val(quesScore);
	}
	

	//评分
	$('.struct-gradecontainer').each(function() {
		$(this).mouseenter(function() { $(this).addClass('hoverwrap') });
	});
	//对号或错号点击事件
	$(".hideimgs").find("img").click(function() {
		//判断点击的是什么标记，如果是对，则把显示img的改为对，并且把第一个隐藏的img改为对，第二个隐藏的img改为叉号；
		//如果是错，则相反
		var liNode = $(this).parents("li")[0];
		var container = $(this).parents(".paperxt_tjxb2");
		var scoreInput = container.find(".struct-grade-score")[0];
		var showImg = container.find(".struct-showimg");
		var firstHideImg = container.find(".firsthideimg");
		var secondHideImg = container.find(".secondhideimg");
		
		if($(this).attr("alt") == "对") {//如果点击了对号
			showImg.attr({src:"<@spring.url '/images/examsystem/gradePaper_right.png'/>", alt:"对"});
			firstHideImg.attr({src:"<@spring.url '/images/examsystem/gradePaper_right.png'/>", alt:"对"});
			secondHideImg.attr({src:"<@spring.url '/images/examsystem/gradePaper_fault.png'/>", alt:"错"});
			if($(liNode).attr("questype") == "4") {
				$(scoreInput).val($(container).find(".tkScore").text());
			} else {
				$(scoreInput).val($(liNode).find(".onequesscore").text());
			}
			
		} else {//如果点击了错号
			showImg.attr({src:"<@spring.url '/images/examsystem/gradePaper_fault.png'/>", alt:"错"});
			firstHideImg.attr({src:"<@spring.url '/images/examsystem/gradePaper_fault.png'/>", alt:"错"});
			secondHideImg.attr({src:"<@spring.url '/images/examsystem/gradePaper_right.png'/>", alt:"对"});
			$(scoreInput).val(0);
		}
		
		$(this).parents('.struct-gradecontainer').removeClass('hoverwrap');
		computeQuesScore(liNode, isMarked(liNode));
	});
	
	
	//编辑分数不正常（分数不是数字，分数大于最大可编辑分数）的操作
	function editOscoreError(node, msg, alertFlag) {
		//如果没有标记或者标记为true，alert信息
		if(alertFlag==undefined || alertFlag) $.chooshine.alert(msg);
		//设置对错号的标记取消
		$(node).parents(".paperxt_tjxb2").find(".struct-showimg").attr("src","<@spring.url '/images/examsystem/gradePaper_right_gray.png'/>");
		
		//如果之前小题已经是批阅过，则已批阅个数减一
		var liNode = $(node).parents("li")[0];
		if(isMarked(liNode) && parseInt($("#struct-markednum").html())!=0) {
			$("#struct-markednum").html(parseInt($("#struct-markednum").html())-1);
			$("#mtopic"+$(liNode).find(".allNum").eq(0).attr("mtopic")).removeClass("answercard-green").addClass("answercard-gray");
			$(liNode).find(".struct-stuscore").eq(0).val("");//设置小题得分为空
		}
	}
	//手动编辑评分处的分数时，当编辑完成，文本框失去焦点时，要重新计算小题得分
	$(".struct-grade-score").each(function() {
		$(this).blur(function() {
			var liNode = $(this).parents("li")[0];
			var gradeScore = $(this).val();	//教师给的分数
			
			if(gradeScore == "") {			//如果当前文本框的值是空
				editOscoreError(this, null, false);
				return;
			} else if(isNaN(gradeScore)) {	//如果文本框内容不是个数字，清空内容，给出提示，去除对错的选择
				$(this).val("");
				editOscoreError(this,"分数必须为有效数字！");
				return;
			} else {						//如果当前文本框的值不是空且是数字，就比较教师给的分数和选项得分（解答题的是小题分数）的大小
				if($(liNode).attr("questype") == "4") {	//如果是填空题
					var oScore = parseInt($($(this).parents(".paperxt_tjxb2")[0]).find(".tkScore").html());
				} else {	//如果是解答题
					var oScore = parseInt($(liNode).find(".onequesscore").text());
				}
				
				if(parseInt(gradeScore) < oScore) {
					$(this).parents(".paperxt_tjxb2").find(".struct-showimg").attr("src","<@spring.url '/images/examsystem/gradePaper_fault.png'/>");
				} else if(parseInt(gradeScore) == oScore){
					$(this).parents(".paperxt_tjxb2").find(".struct-showimg").attr("src","<@spring.url '/images/examsystem/gradePaper_right.png'/>");
				} else {
					$(this).val("");
					editOscoreError(this, "得分不能大于选项分数和小题分数");
					return;
				}
			}
			
			computeQuesScore(liNode, isMarked(liNode));
		});
	});
	
	//禁止向文本框输入非数字字符
	$(".struct-grade-score").each(function() {
		disableInputKeyUpNoNumber(this);
	});
	/**********************************查看答案*******************************/
	//点击“查看答案”或“收起答案”
	$(".network-openrefer").click(function() {
		var cmdNode = $(this).find(".struct-opencmd")[0];
		if($(cmdNode).html() == "查看答案▼") {
			$(cmdNode).html("收起答案▲");
			$($(this).parents("li")[0]).find(".gradepaper-referanswer").show();
		} else {
			$(cmdNode).html("查看答案▼");
			$($(this).parents("li")[0]).find(".gradepaper-referanswer").hide();
		}
	});
	/**********************************保存、提交******************************/
	//收集主观题的信息并提交
	function submitOperateInfo(operateType) {
		$(".struct-comment").each(function() {
			var liNode = $(this).parents("li")[0];
			var quesId = $(liNode).attr("id").substring(4,$(liNode).attr("id").length);
			
			//以小题的编号为键名保存小题的得分
			quesScoreArr[quesId] = $($(liNode).find(".struct-stuscore")[0]).val();
			//得到填空题的选项得分，以，分隔，以小题编号为键名保存
			if($(liNode).attr("questype") == "4") {
				var oScoreStr = "";
				$(liNode).find(".struct-grade-score").each(function() {
					oScoreStr = oScoreStr+$(this).val()+",";
				});
				if(oScoreStr.length > 1) oScoreArr[quesId] = oScoreStr.substring(0, oScoreStr.length-1);
			}
			
			//得到小题的评语
			if($(this).html().trim() != "点击输入评语") {
				commentArr[quesId] = encodeURIComponent(encodeURIComponent(cleanBr($(this).html().trim())));
			} else {
				commentArr[quesId] = "";
			}
			
		});
		
		//将小题的信息存到数据库
		$.ajax({
			url:"<@spring.url '/examsystem/gradePapers.json'/>",
			type:"POST",
			contentType:"application/x-www-form-urlencoded; charset=utf-8",
			data:"testRecId="+${testRecId?c}+
			 "&quesScoreJson="+JSON.stringify(quesScoreArr)+
			 "&oScoreJson="+JSON.stringify(oScoreArr)+
			 "&commentJson="+JSON.stringify(commentArr)+
			 "&operateType="+operateType,
			success:function(data) {
				if(operateType == "submit") {
					$("#SubmitGradeResult").submit();
				} else if(operateType == "view") {
					changeView();
				}
			}
		});
	}
	
	
	//点击保存，保存试卷信息
	$("#struct-grade-save").click(function() {
		if($("#struct-grade-save").attr("autoflag") != "auto") $.chooshine.alert("保存成功！");
		$("#struct-grade-save").attr("autoflag", "");
		submitOperateInfo("save");
	});
	<#if markInfo["mark_flag"]!=2>
	//自动保存
	saveInterval = window.setInterval(autoSave,30000);
	</#if>
	//调用自动触发点击保存事件的方法
	function autoSave() {
		$("#struct-grade-save").attr("autoflag", "auto");
		triggerMouseEvent(document.getElementById("struct-grade-save"), "click");
	}
	
	//点击提交
	$("#struct-grade-submit").click(function() {
		//判断是否有未评阅的小题，如果有，不允许提交
		var subjectiveNum = $("#struct-subjectivenum").html();
		var markedNum = $("#struct-markednum").html();
		if(markedNum.trim() != subjectiveNum.trim()) {
			$.chooshine.alert("您当前还有"+(subjectiveNum-markedNum)+"道主观题未评阅，<br>请全部批阅后提交。");
			return;
		}
		//取消自动保存
		<#if markInfo["mark_flag"]!=2>
		window.clearInterval(saveInterval);
		</#if>
		//提交信息
		submitOperateInfo("submit");
	});
	
	//点击退出
	$("#struct-grade-quit").click(function() {
		$.chooshine.confirm("您未保存的阅卷记录将丢失，是否退出？", function() {
			$("#QuitExam").submit();
		});
	});
	
	//点击“进入下一大题”
	$("#EnterNextType").click(function() {
		triggerMouseEvent($("#"+nowId).next()[0], "click");
		window.scrollTo(0, 0);
	});
//*********************************答题卡的操作************************************
	$(".struct-nq").each(function(index) {
		//删除最后一题的“下一题”
		if(index == $(".struct-nq").length-1){
			$(this).parent().remove();
		}
		//点击小题的“下一题”
		$(this).click(function() {
			//得到当前小题的大题的id和下一小题的大题id
			var liNode = $(this).parents("li")[0];
			var mTopic = $($(liNode).find(".allNum")[0]).attr("mtopic");
			var currentIndex = $(liNode).find(".allNum").index('.allNum');
			var nextLiNode = $($(".allNum")[currentIndex+1]).parents("li")[0];
			
			var typeId = $(".paperx_comxp").attr("id");
			var nextLiTypeId = $(nextLiNode).parents(".paperx_com").attr("id");
			
			//如果根据paperx_com这个类找到的下一个节点不是undefined，则说明下一小题和当前小题不是同一大题
			if(nextLiTypeId != undefined) {
				oldId=nowId;	//将点击前显示的大题的编号变成oldId
				nowId=nextLiTypeId.substr(4);	//将点击后显示的大题的编号变成nowId
				initChange();	//设置当前选中大题下的基本信息
			}
			
			var x = $(nextLiNode).offset().left;
			var y = $(nextLiNode).offset().top-120;
			//将滚动条滚动到制定位置
			window.scrollTo(x, y);
		});
	});
	//点击答题卡中的小题号
	$(".answercard-question").each(function(){
		$(this).click(function(){
			oldId=nowId;	//将点击前显示的大题的编号变成oldId
			nowId=$($(this).parents(".answercard-answerul")[0]).attr("id");	//将点击后显示的大题的编号变成nowId
			initChange();	//设置当前选中大题下的基本信息
			//得到小题的位置
			var liNode = $("#ques"+$(this).attr("quesid"));
			if(liNode[0] != undefined) {	//如果页面存在当前小题（批主观题页面会出现不存在客观小题的情况）
				var x = $(liNode).offset().left;
				var y = $(liNode).offset().top-54;
				//将滚动条滚动到制定位置
				window.scrollTo(x, y);
			} else {
				var mtopicId = $(this).attr("id");
				location.href = urlConstant+"&mtopicId="+mtopicId;
			}
			
		});
	});
	
	<#if mtopicId??>
		$('#${mtopicId}').trigger("click");
	</#if>
	
	//点击查看全部或批主观题
	$('#View').click(function() {
		submitOperateInfo("view");
	});
	//切换查看种类
	function changeView() {
		if($('#View').text() == viewConstant) window.location.href = urlConstant;	
		else window.location.href = urlConstant+"&questype=subjective";
	}
//**********************************插入公式***************************************
	//对题干、选项、答案及解析的公式进行处理
	$(".equlabel").each(function() {
		//将页面加载的转换后的img标签转换回来
		$(this).html(changeImgToNormal($(this).html(), rootPath));
	});
	
	//解答题和填空题评语的点击事件
	$(".equ").each(function() {
		//将页面加载的转换后的img标签转换回来
		$(this).html(changeImgToNormal($(this).html(), rootPath));
		findDivEventMouseup(this);	//将当前文本框设置为要插入公式的节点
		textboxClick(this, "点击输入评语");	//为当前文本框添加点击事件
		
		//公式图片添加双击事件
		$(this).find("img").each(function() {
			if(!($(this).attr("data-latex") == undefined)) {
				$(this).dblclick(function() {
					formulaDbClickEvent(this);
				});
			}
		});
	});
	/* $(".struct-comment").blur(function() {
		if(cleanBr($(this).html().trim())==""){
			$(this).html("点击输入评语").css("color", "#ddd");
		}
	}); */
	//点击插入公式和上传图片
	//初始化的时候加载添加图片方法
	$(".addequation").each(function(){
		addEventClick(this);
	});
	$(".addequation_local").each(function(){
		addLocalPhoto(this);
	});
	$(".struct-kf").each(function() {
		$(this).click(function() {
			openKity();
		});
	});
	$(".struct-ue").each(function() {
		addClickEventToUeditorBtn(this);
	});
	$(".struct-hist").each(function() {
		$(this).click(function() {
			openFormulaHistory();
		});
	});
});

//****************************录音部分********************************
//给每个小题添加录音功能
$(".paperx_tl").each(function(index) {
	addRecorder(this, index);
});
$(".struct-commentrec").click(function() {
	enterRecorderEvent(this);
});
/**
* 小题的录音入口点击事件
* @param node 录音入口节点
*/
function enterRecorderEvent(node) {
	var quesNode = $(node).parents(".paperx_tl");
	if(quesNode[0] == undefined) quesNode = $("#GradeScoreDialog");
	var	startRecordNode = quesNode.find(".start-recording")[0],
		pauseRecordNode = quesNode.find(".pause")[0];
	
	triggerMouseEvent(startRecordNode, "click");//自动触发录音按钮点击事件
	//如果停止录音图标是显示状态，说明当前进入了录音状态，要隐藏录音入口图标;否则，说明当前刚选择了允许flash，不隐藏录音入口图标
	if(!quesNode.find(".stop-recording").is(":hidden")) {
		$(node).addClass("hide");
		triggerMouseEvent(pauseRecordNode, "click");//自动触发暂停按钮点击事件
	}
}
//上传录音并显示播放器之后要做的事情
function doAfterUploadWav(recorderWrap, path) {
	//如果是小题的录音，则要设置小题的评语录音，否则，设置作业记录的评语录音
	//设置小题的评语录音
	$.get("<@spring.url '/setTestRecordDetailCommentRec.json' />", {testRecId:${testRecId?c}, quesId:$(recorderWrap).parents(".paperx_tl").parent().attr("id").substring(4), path:path.substring(1)});
}
//删除录音之后做的处理
function doAfterDeleteWav(recorderWrap) {
	var quesNode = $(recorderWrap).parents(".paperx_tl");
	//设置小题对应的评语录音为空字符串
	$.get("<@spring.url '/setTestRecordDetailCommentRec.json' />", {testRecId:${testRecId?c}, quesId:quesNode.parent().attr("id").substring(4), path:null});
	//显示录音按钮
	quesNode.find(".struct-commentrec").removeClass("hide");
}
//点击输入框时要做的特殊处理
function doWhenClickInput(node) {
	//判断当前是否是录音状态或者播放状态，若是，则不显示录音入口，否则显示录音入口
	var quesNode = $(node).parents(".paperx_tl");
	if(quesNode.find(".stop-recording").is(":visible") || !quesNode.find(".chooshinejp").hasClass("hide")) {
		quesNode.find(".struct-commentrec").addClass("hide");
	}
}
</script>